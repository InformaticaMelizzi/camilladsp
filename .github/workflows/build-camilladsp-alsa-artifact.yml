name: build-camilladsp-alsa-artifact
on: { workflow_dispatch: {} }
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { ref: master }
      - uses: dtolnay/rust-toolchain@stable
      - name: Deps
        run: sudo apt-get update && sudo apt-get install -y pkg-config libasound2-dev
      - name: Build ALSA-only
        env: { RUSTFLAGS: "-C target-cpu=x86-64-v2" }
        run: |
          cargo build --release --no-default-features --features backend-alsa,websocket
          strip target/release/camilladsp
          ldd target/release/camilladsp | grep -i pulse || echo "OK no Pulse"
      - name: Pack
        run: |
          mkdir -p dist && cp target/release/camilladsp dist/
          tar -C dist -czf camilladsp-linux-amd64-alsa.tar.gz camilladsp
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: camilladsp-linux-amd64-alsa
          path: camilladsp-linux-amd64-alsa.tar.gz
